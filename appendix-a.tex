\textbf{SOMETHING IS MESSED UP WITH APPENDIX THEOREM NUMBERING... FIX THIS}
\section{Rules of \dlambdaamor}

\section{\dlambdaamor Theorems and Proofs}

\ctxwfstreng*
\begin{proof}
Immediate from the fact that $\Psi ; \Theta ; \Delta \vdash \Gamma \; \texttt{wf}$ exactly when $\Psi ; \Theta ; \Delta \vdash \tau : \star$ for every $x : \tau \in \Gamma$.
\end{proof}

\conwfstreng*
\begin{proof}
Immediate by inversion.
\end{proof}

\begin{theorem}[Raw Admissibility of Weakening for Sort Checking]
If $\Theta ; \Delta \vdash I : S$ and $\Theta' \supseteq \Theta$, then $\Theta' ; \Delta \vdash I : S$
\end{theorem}

\begin{theorem}[Raw Admissibility of Weakening for Constraint Well-Formedness]
If $\Theta ; \Delta \vdash \Phi \; \texttt{ wf}$ and $\Theta' \supseteq \Theta$, then $\Theta' ; \Delta \vdash \Phi \; \texttt{ wf}$
\end{theorem}

\begin{theorem}[Admissibility of Weakening for Constraint Context Well-Formedness]
If $\Theta \vdash \Delta \; \texttt{wf}$ and $\Theta' \supseteq \Theta$, then $\Theta' \vdash \Delta \; \texttt{wf}$
\end{theorem}

\begin{theorem}[Admissibility of Weakening for Sort Checking]
If $\Theta ; \Delta \pvdash I : S$ and $\Theta' \supseteq \Theta$, then $\Theta' ; \Delta \pvdash I : S$
\end{theorem}

\begin{theorem}[Admissibility of Weakening for Constraint Well-Formedness]
If $\Theta ; \Delta \pvdash \Phi \; \texttt{wf}$ and $\Theta' \supseteq \Theta$, then $\Theta' ; \Delta \pvdash \Phi \; \texttt{ wf}$
\end{theorem}

\begin{theorem}[Index Substitution for Sort Checking]
If $\Theta, j : S_1 ; \Delta \pvdash I : S_2$ and $\Theta ; \Delta \pvdash J : S_1$ then $\Theta ; \Delta \pvdash I[J/j] : S_2$
\label{thm:idx-idx-subst}
\end{theorem}
\input{proofs/idx-idx-subst}

\begin{theorem}[Index Substitution for Constraint Well-Formedness]
If $\Theta, i : S ; \Delta \pvdash \Phi \; \texttt{wf}$ and $\Theta ; \Delta \pvdash I : S$ then $\Theta ; \Delta \pvdash \Phi[I/i] \; \texttt{wf}.$
\label{thm:constr-idx-subst}
\end{theorem}
\input{proofs/constr-idx-subst}


\begin{theorem}[Admissibility of Weakening for Type Formation]
If $\Psi ; \Theta ; \Delta \pvdash \tau : K$, $\Psi' \supseteq \Psi$, and $\Theta' \supseteq \Theta$, then
$\Psi' ; \Theta' ; \Delta \pvdash \tau : K$.
\end{theorem}

\begin{theorem}[Admissibility of Weakening for Term Context Wellformedness]
If $\Psi ; \Theta ; \Delta \vdash \Gamma \; \texttt{wf}$, $\Psi' \supseteq \Psi$, and $\Theta' \supseteq \Theta$, then
$\Psi' ; \Theta' ; \Delta \vdash \Gamma \; \texttt{wf}$.
\end{theorem}

\typeidxsubst*
\input{proofs/type-idx-subst}

\begin{theorem}[Admissibility of Weakening for Subtyping]
Suppose $\Psi ; \Theta ; \Delta \pvdash \tau \subty \tau' : K$, $\Psi' \supseteq \Psi$, and $\Theta' \supseteq \Theta$.
Then, $\Psi' ; \Theta' ; \Delta \pvdash \tau \subty \tau'$.
\end{theorem}

\subtystreng*
\begin{proof}
Routine induction.
\end{proof}


\begin{theorem}[Context Subsumption Includes Subset]
If $\Psi ; \Theta ; \Delta \pvdash \Gamma'$ and $\Gamma \subseteq \Gamma'$ as sets, then $\Psi ; \Theta ; \Delta \pvdash \Gamma' \wknto \Gamma$
\label{thm:ctx-sub-subset1}
\end{theorem}
\begin{proof}
By induction on $|\Gamma|$.
If $\Gamma = \emptyset$, this is immediate by CS-Emp.
Now suppose $\Gamma = \Gamma'', x : \tau$. Then, since $\Gamma \subseteq \Gamma'$, we have $x : \tau \in \Gamma'$, and $\Gamma'' \subseteq \Gamma' \setminus \{x : \tau\}$. Moreover, by S-Refl, $\Psi ; \Theta ; \Delta \vdash \tau \subty \tau : \star$, and so we are done by IH.
\end{proof}

\ctxsubsubset*
\begin{proof}
By an easy induction on $|\Gamma|$.
\end{proof}

\begin{theorem}[Admissibility of Weakening for Context Subsumption]
If $\Psi ; \Theta ; \Delta \pvdash \Gamma \wknto \Gamma'$ and $\Psi' \supseteq \Psi$, $\Theta' \supseteq \Theta$, and $\Delta' \supseteq \Delta$, then
$\Psi' ; \Theta' ; \Delta' \pvdash \Gamma \wknto \Gamma'$
\label{thm:ctx-sub-wkn}
\end{theorem}

\begin{theorem}[Strengthening for Context Subsumption]
Suppose $\Psi ; \Theta ; \Delta \vdash \Gamma,\Gamma' \texttt{ wf}$.
If $\Psi' ; \Theta' ; \Delta \pvdash \Gamma \wknto \Gamma'$ with $\Theta' \supseteq \Theta$ and $\Psi' \supseteq \Psi$, then $\Psi ; \Theta ; \Delta \pvdash \Gamma \wknto \Gamma'$.
\end{theorem}
\label{thm:ctx-sub-streng}
\begin{proof}
Immediate by Theorem~\ref{thm:ctx-sub-subset2} and Theorem~\ref{thm:subty-streng}
\end{proof}

\ctxsubswap*
\begin{proof}
By Theorem~\ref{thm:ctx-sub-subset2}, it suffices to show that for every $x : \tau \in \Gamma_2'$, there is some $\tau'$ such that $x : \tau' \in \Gamma_2'$,
and $\Psi ; \Theta ; \Delta \vdash \tau' \subty \tau : \star$. Suppose $x : \tau \in \Gamma_2'$. Then, $x : \tau \in \Gamma_1'$. Further, since $\Psi' ; \Theta' ;  \Delta' \vdash \Gamma_2 \wknto \Gamma_2'$, there is some $\tau'$ such that $x : \tau' \in \Gamma_2$. But then, $x : \tau' \in \Gamma_1$, and so since  $\Psi ; \Theta ; \Delta \vdash \Gamma_1 \wknto \Gamma_1'$, we have that $\Psi ; \Theta ; \Delta \vdash \tau' \subty \tau : \star$, by Theorem~\ref{thm:ctx-sub-subset2}.
\end{proof}

\subsection{Normalization}

\canonforms*
\begin{proof}
Inversion on $\Psi ;\Theta ; \Delta \vdash \tau : S \to K$  and then $\tau \; \texttt{nf}$.
\end{proof}

\idxsubstnf*
\begin{proof}
By an easy simultaneous induction. This is only true because we don't require index terms inside a type to be in normal form for the type to be in normal form.
\end{proof}

\idxsubsteval*
\begin{proof}
Induction on $\tau$.
\end{proof}

%Define $\# \tau$ to be the number of type connectives in $\tau$.

\normthm*
\input{proofs/norm-thm}

\begin{theorem}
~\begin{itemize}
  \item If $\tau \; \texttt{nf}$, then $\texttt{eval}(\tau) = \tau$
  \item If $\tau \; \texttt{ne}$, then $\texttt{eval}(\tau) = \tau$
\end{itemize}
\label{thm:norm-idemp}
\end{theorem}
\begin{proof}
Simultaneous induction.
\end{proof}

\section{Rules of \bilambdaamor}

\section{Soundness and Completeness}

\begin{theorem}[Raw Soundness of Sort Checking/Inference]
If $\Theta;\Delta \vdash I : S \gens \Phi$ and $\Theta;\Delta \vDash \Phi$, then $\Theta;\Delta \vdash I : S$ 
\label{thm:raw-sort-sound}
\end{theorem}
\input{proofs/sort-sound}

\begin{theorem}[Raw Soundness of Constraint Well-Formedness]
If $\Theta ; \Delta \vdash \Phi \gens \Phi'$ and $\Theta ; \Delta \vDash \Phi'$ then $\Theta ; \Delta \vdash \Phi \texttt{ wf}$
\label{thm:raw-constr-sound}
\end{theorem}
\input{proofs/constr-sound}

\idxctxwfsound*
\begin{proof}
By induction on $\Theta \vdash \Delta \; \texttt{wf} \gens \Phi$. The base case is immediate. Suppose $\Theta \vdash \Delta, \Phi \; \texttt{wf} \gens \Phi_1 \wedge (\bigwedge \Delta \to \Phi_2)$ with $\Theta ; \cdot \vDash \Phi_1 \wedge (\bigwedge \Delta \to \Phi_2)$, by way of
$\Theta \vdash \Delta \; \texttt{wf} \gens \Phi_1$ and $\Theta ; \Delta \vdash \Phi \; \texttt{wf} \gens \Phi_2$.
Since $\Theta ; \cdot \vDash \Phi_1$, we have by IH that $\Theta \vdash \Delta \; \texttt{wf}$. By Theorem~\ref{thm:raw-sort-sound}, since $\Theta ; \Delta \vDash \Phi_2$, we have that $\Theta ; \Delta \vdash \Phi_2 \; \texttt{wf}$, and so $\Theta \vdash \Delta, \Phi \; \texttt{wf}$, as required.
\end{proof}

\sortsound*
\begin{proof}
Immediate by Theorem~\ref{thm:raw-sort-sound} and Theorem~\ref{thm:idx-ctx-wf-sound}
\end{proof}


\constrsound*
\begin{proof}
Immediate by Theorem~\ref{thm:raw-constr-sound} and Theorem~\ref{thm:idx-ctx-wf-sound}
\end{proof}

\begin{theorem}[Raw Soundness of Kind Checking/Inference]
If $\Psi ; \Theta ; \Delta \vdash \tau : K \gens \Phi$ and $\Theta ; \Delta \vDash \Phi$ then $\Psi ; \Theta ; \Delta \vdash \tau : K$.
\label{thm:raw-kind-sound}
\end{theorem}
\input{proofs/kind-sound}

\kindsound*
\begin{proof}
Immediate by Theorem~\ref{thm:raw-kind-sound} and Theorem~\ref{thm:idx-ctx-wf-sound}
\end{proof}

\begin{theorem}[Raw Soundness of Subtyping for Normal Forms]
If $\Psi ; \Theta ; \Delta \vdash \tau_1 \subtynf \tau_2 : K \gens \Phi$ and $\Theta ; \Delta \vDash \Phi$ then $\Psi ; \Theta ; \Delta \vdash \tau_1 \subty \tau_2 : K$\label{thm:raw-subtynf-sound}
\end{theorem}
\input{proofs/subtynf-sound}

\subtynfsound*
\begin{proof}
Immediate by Theorem~\ref{thm:raw-subtynf-sound} and Theorem~\ref{thm:idx-ctx-wf-sound}
\end{proof}

\subtysound*
\begin{proof}
There is only one case: $\Psi ; \Theta ; \Delta \vdash \tau_1 \subty\tau_2 : K \gens \Phi$ by way of $\Psi ; \Theta ; \Delta \vdash \texttt{eval}(\tau_1) \subtynf \texttt{eval}(\tau_2) : K \gens \Phi$ with $\Theta ; \Delta \vDash \Phi$. By Theorem~\ref{thm:subtynf-sound}, $\Psi ; \Theta ; \Delta \vdash \texttt{eval}(\tau_1) \subty \texttt{eval}(\tau_2) : K$. By Theorem~\ref{thm:norm-thm} and two uses of S-Trans, $\Psi ; \Theta ; \Delta \pvdash \tau_1 \subty \tau_2 : K$, as required.
\end{proof}

\begin{theorem}[Output Context is Uniquely Determined]
For any $\Psi,\Theta,\Delta,\Gamma,e,\Phi$, there is at most one $\Gamma'$ so that $\Psi ; \Theta ; \Delta ; \Omega ; \Gamma \vdash e \updownarrow \tau \gens \Phi, \Gamma'$
\label{thm:ctx-uniquely-determined}
\end{theorem}
\begin{proof}
Inspection of rules.
\end{proof}

\lsc*
\begin{proof}
Induction on $\Psi ; \Theta ; \Delta ; \Omega ; \Gamma \vdash e \updownarrow \tau \gens \Phi, \Gamma'$.
\end{proof}

\begin{theorem}[Output Context is Well-Formed]
If $\Psi ; \Theta ; \Delta ; \Omega ; \Gamma \pvdash e \updownarrow \tau \gens \Phi,\Gamma'$ then $\Psi ; \Theta ; \Delta \vdash \Gamma' \; \texttt{wf} \gens \Phi'$ with $\Theta ; \Delta \vDash \Phi'$.
\end{theorem}
\begin{proof}
An easy induction on $\Gamma'$, using the fact that $\Psi ; \Theta ; \Delta \vdash \Gamma \; \texttt{wf} \gens \Phi''$ with $\Theta ; \Delta \vDash \Phi''$, and Theorem~\ref{thm:lsc}
\end{proof}

\begin{theorem}[Algorithmic Well-Formedness of Context Operations]
If $\Gamma_1,\Gamma_2 \subseteq \Gamma$ such that $\Psi ; \Theta ; \Delta \vdash \Gamma \; \texttt{wf}$, then the following are true:
\begin{enumerate}
  \item $\Psi ; \Theta ; \Delta \vdash \Gamma_1,\Gamma_2 \; \texttt{wf}$
  \item $\Psi ; \Theta ; \Delta \vdash \Gamma_1 \cap \Gamma_2 \; \texttt{wf}$
  \item $\Psi ; \Theta ; \Delta \vdash \Gamma_1\setminus\Gamma_2 \; \texttt{wf}$
\end{enumerate}
\end{theorem}

\theorem[Raw Soundness of Type Checking/Inference]{
~\begin{enumerate}
 \item If $\Psi;\Theta;\Delta;\Omega;\Gamma \vdash e \checks \tau \gens \Phi, \Gamma'$ and $\Theta;\Delta \vDash \Phi$ then $\Psi;\Theta;\Delta;\Omega;\Gamma \setminus \Gamma' \vdash |e| : \tau$
 \item If $\Psi;\Theta;\Delta;\Omega;\Gamma \vdash e \infers \tau \gens \Phi, \Gamma'$ and $\Theta;\Delta \vDash \Phi$ then $\Psi;\Theta;\Delta;\Omega;\Gamma \setminus \Gamma' \vdash |e| : \tau$
\end{enumerate}
}
%\textbf{Redo in new style}
\label{thm:raw-tycheck-sound}
\input{proofs/tycheck-sound}

\tychecksound*
\begin{proof}
Immediate by \ref{thm:raw-tycheck-sound}.
\end{proof}

%%%
% COMPLETENESS
%%%



\begin{theorem}[Raw Completeness of Sort Checking/Inference]
If $\Theta;\Delta \vdash I : S$, then $\Theta;\Delta \vdash I : S \gens \Phi$ and $\Theta;\Delta \vDash \Phi$.
%\textbf{REDO THIS, FIX Proof file Name}
\label{thm:raw-sort-compl}
\end{theorem}
\input{proofs/sort-compl}

\begin{theorem}[Raw Completeness of Constraint Well-Formedness]
If $\Theta ; \Delta \vdash \Phi \; \texttt{wf}$, then $\Theta ; \Delta \vdash \Phi \; \texttt{wf} \gens \Phi'$ with $\Theta ; \Delta \vDash \Phi'$
\label{thm:raw-constr-compl}
\end{theorem}

\idxctxwfcompl*
\begin{proof}
By induction on $\Theta \vdash \Delta \; \texttt{wf}$. The base case is immediate.
Suppose $\Theta \vdash \Delta,\Phi \; \texttt{wf}$ by way of $\Theta \vdash \Delta \; \texttt{wf}$ and $\Theta ; \Delta \vdash \Phi \; \texttt{wf}$.
By IH, there is some $\Phi_1$ such that $\Theta \vdash \Delta \; \texttt{wf} \gens \Phi_1$ with $\Theta ; \cdot \vDash \Phi_1$. By Theorem~\ref{thm:raw-constr-compl}, there is $\Phi_2$ such that $\Theta ; \Delta \vdash \Phi \; \texttt{wf} \gens \Phi_2$ with $\Theta ; \Delta \vDash \Phi_2$. Equivalently, $\Theta ; \cdot \vDash \bigwedge \Delta \to \Phi_2$, and so $\Theta ; \cdot \vDash \Phi_1 \wedge (\bigwedge \Delta \to \Phi_2)$. Then, by AWF-CCtx-Ne, $\Theta \vdash \Delta,\Phi \; \texttt{wf} \gens \Phi_1 \wedge (\bigwedge \Delta \to \Phi_2)$, as required.
\end{proof}

\sortcompl*
\begin{proof}
Immediate by Theorem~\ref{thm:raw-sort-compl} and Theorem~\ref{thm:idx-ctx-wf-compl}
\end{proof}

\constrcompl*
\begin{proof}
Immediate by Theorem~\ref{thm:raw-constr-compl} and Theorem~\ref{thm:idx-ctx-wf-compl}
\end{proof}

\begin{theorem}[Raw Completeness of Kind Checking/Inference]
If $\Phi;\Theta;\Delta \vdash \tau : K$, then $\Phi;\Theta;\Delta \vdash \tau : K \gens \Phi$ with $\Theta ; \Delta \vDash \Phi$
\label{thm:raw-kind-compl}
\end{theorem}
\input{proofs/raw-kind-compl}

\kindcompl*
\begin{proof}
Immediate by Theorem~\ref{thm:raw-kind-compl} and Theorem~\ref{thm:idx-ctx-wf-compl}.
\end{proof}

\subtynerefl*
\input{proofs/subtyne-refl}

\subtynfrefl*
\input{proofs/subtynf-refl}

\subtynftrans*
\input{proofs/subtynf-trans}


\begin{theorem}[Index Substitution for Algorithmic Sort Checking]
If $\Theta, i : S ; \Delta \pvdash J : S' \gens \Phi_1$ and $\Theta ; \Delta \pvdash I : S \gens \Phi_2$ with
$\Theta, i : S ; \Delta \vDash \Phi_1$ and $\Theta; \Delta \vDash \Phi_2$, then
$\Theta ; \Delta \pvdash J[I/i] : S' \gens \Phi$ for some $\Theta ; \Delta \vDash \Phi$
\label{idx-idx-algo-subst}
\end{theorem}
\begin{proof}
By Theorem~\ref{thm:sort-sound}, $\Theta, i :S ; \Delta \pvdash J : S'$ and $\Theta ; \Delta \pvdash I : S$.
By Theorem~\ref{thm:idx-idx-subst}, $\Theta ; \Delta \pvdash J[I/i] : S'$.
By Theorem~\ref{thm:sort-compl}, $\Theta ; \Delta \pvdash J[I/i] : S' \gens \Phi'$ for some $\Phi'$ such that $\Theta ; \Delta \vDash \Phi'$.
\end{proof}

\begin{theorem}[Index Substitution for Algorithmic Constraint Well-Formedness]
If $\Theta, i : S; \Delta \pvdash \Phi \; \texttt{wf} \gens \Phi_1$ and $\Theta ; \Delta \pvdash I : S \gens \Phi_2$
with $\Theta, i : S ; \Delta \vDash \Phi_1$ and $\Theta ; \Delta \vDash \Phi_2$, then
$\Theta ; \Delta \pvdash  \Phi[I/i] \; \texttt{wf} \gens \Phi'$ for some $\Theta ; \Delta \vDash \Phi'$
\label{thm:constr-idx-algo-subst}
\end{theorem}
\begin{proof}
By Theorem~\ref{thm:constr-sound}, $\Theta, i : S ; \Delta \pvdash \Phi \; \texttt{wf}$.
By Theorem~\ref{thm:sort-sound}, $\Theta ; \Delta \pvdash I : S$.
By Theorem~\ref{thm:constr-idx-subst}, $\Theta ; \Delta \pvdash \Phi[I/i] \; \texttt{wf}$.
By Theorem~\ref{thm:constr-compl}, $\Theta ; \Delta \pvdash \Phi[I/i] \; \texttt{wf} \gens \Phi'$ for some $\Theta ; \Delta \vDash \Phi'$
\end{proof}

\begin{theorem}[Index Substitution for Algorithmic Type Formation]
If $\Psi ; \Theta, i : S ; \Delta \pvdash \tau : K \gens \Phi_1$ and $\Theta ; \Delta \pvdash I : S \gens \Phi_2$ 
with $\Theta, i : S ; \Delta \vDash \Phi_1$ and $\Theta ; \Delta \vDash \Phi_2$, then
$\Psi ; \Theta ; \Delta \pvdash \tau[I/i] : K \gens \Phi$ for some $\Theta ; \Delta \vDash \Phi$
\label{thm:type-idx-algo-subst}
\end{theorem}
\begin{proof}
By Theorem~\ref{thm:kind-sound}, $\Psi ; \Theta, i : S ; \Delta \pvdash \tau : K$.
By Theorem~\ref{thm:sort-sound}, $\Theta ; \Delta \pvdash I : S$.
By Theorem~\ref{thm:type-idx-subst}, $\Psi ; \Theta ; \Delta \pvdash \tau[I/i] : K$.
Finally, by Theorem~\ref{thm:kind-compl}, $\Psi ; \Theta ; \Delta \pvdash \tau[I/i] : K \gens \Phi$ for some $\Theta ; \Delta \vDash \Phi$
\end{proof}

\subtynfidxsubst*
\input{proofs/subtynf-idx-subst}

\evalapplemma*
\begin{proof}
By inversion on $\Psi ; \Theta ; \Delta \vdash \texttt{eval}(\tau_1) \subtynf \texttt{eval}(\tau_2) : S \to K \gens \Phi$.
\begin{itemize}
  \item For the first case, suppose the derivation was $\Psi ; \Theta ; \Delta \vdash \lambda i : S. \tau_1' \subtynf \tau_2' : S \to K \gens \Phi$
  from $\Psi ; \Theta, i : S ; \Delta \vdash \tau_1' \subtynf \tau_2' : K \gens \Phi'$. By Theorem~\ref{thm:subtynf-idx-subst},
  $\Psi ; \Theta ; \Delta \pvdash \tau_1'[I/i] \subtynf \tau_2'[J/i] : K \gens \Phi'$, for some $\Theta ; \Delta \vDash \Phi'$. But $\texttt{eval}(\tau_1 \; I) = \tau_1'[I/i]$ and $\texttt{eval}(\tau_2 \; J) = \tau_2'[J/i]$.
  \item Now, suppose the derivation was $\Psi ; \Theta ; \Delta \vdash \tau_1' \; L_1 \subtynf \tau_2' \; L_2 : S \to K \gens \Phi \wedge (L_1 = L_2)$, where $\texttt{eval}(\tau_1) = \tau_1' \; L_1$ and $\texttt{eval}(\tau_2) = \tau_2 \; L_2$. These must both be $\texttt{ne}$, since they are both applications, and therefore
  $\texttt{eval}(\tau_1) \; I = \texttt{eval}(\tau_1 \; I)$ and $\texttt{eval}(\tau_2) \; J = \texttt{eval}(\tau_2 \; J)$, as required.
\end{itemize}
\end{proof}

\subtycompl*
\input{proofs/subty-compl}

\admitsweaken*
\input{proofs/admits-weaken}

\tycheckcompl*
\input{proofs/tycheck-compl}